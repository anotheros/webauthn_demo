<!DOCTYPE html>
<html>
    <head>
        <title>WebAuthN</title>
        <style type="text/css">
            thead td { width: 200px; }
            td {
                max-width: 180px;
                overflow: hidden;
                text-overflow: ellipsis;
            }
            .banner {
                min-height: 18px;
                text-align: center;
                background-color: black;
                color: white;
            }
        </style>
    </head>
    <body>
        <script src="https://rawgit.com/paroga/cbor-js/master/cbor.js" type="text/javascript"></script>
        <script src="https://rawgit.com/mvndaai/webauthn/master/webauthn-helper.js" type="text/javascript"></script>
        <script src='//unpkg.com/mithril/mithril.js'></script>
        <script>
            let bannerText = '';
            function updateBannerText(...s) { console.log(...s); bannerText = s.join('-'); }
            let users = [];
            function updateUsers() { return m.request('/users').then(r => users = r); }

            function register(username, displayName) {
                updateBannerText("Attempting to register", username, displayName);
                m.request({
                    method: "POST", url: "/registration/start",
                    data: { name: username, displayName: displayName }
                })
                .then(r => {
                    sessionStorage.setItem('challenge', r.publicKey.challenge);
                    return navigator.credentials.create(webauthn.buildPublicKey(r));
                })
                .then(r => { // https://developer.mozilla.org/en-US/docs/Web/API/PublicKeyCredential
                    // JavaScript decode clientDataJSON
                    // var a = JSON.parse(atob(webauthn.binToStr(r.response.clientDataJSON)));
                    // console.log('clientData', a)
                    // JavaScript decode attestationObject
                    // var a = CBOR.decode(r.response.attestationObject);
                    // console.log('cbor', a)

                    console.log(r);
                    let cred = {response: {}};
                    if ('id' in r) cred.id = r.id;
                    if ('type' in r) cred.type = r.type;
                    if ('rawId' in r) cred.rawId = webauthn.binToStr(r.rawId);
                    cred.response.clientDataJSON = webauthn.binToStr(r.response.clientDataJSON);
                    cred.response.attestationObject = webauthn.binToStr(r.response.attestationObject);
                    console.log('cred', cred)

                    sessionStorage.getItem('challenge');
                    sessionStorage.setItem('rawId', webauthn.binToStr(r.rawId));


                    // JavaScript print clientDataJSON
                    // let clientDataJSON = JSON.parse(atob(webauthn.binToStr(attestation.response.clientDataJSON)));
                    // console.log(JSON.stringify(clientDataJSON));
                    // let exampleClientDataJSON = {
                    //     "challenge": "MHivbnh7JuW1RxmvXQHgleZctX2LeTzajHnFJR5dC6k",
                    //     "new_keys_may_be_added_here": "do not compare clientDataJSON against a template. See https://goo.gl/yabPex",
                    //     "origin": "https://wet-grasshopper-0.telebit.cloud",
                    //     "type": "webauthn.create"
                    // }

                    // JavaScript print attestationObject
                    // let attestationObject = CBOR.decode(attestation.response.attestationObject);
                    // console.log(JSON.stringify(attestationObject))
                    // let exampleAttestationObject = {
                    //     "fmt":"fido-u2f",
                    //     "attStmt":{
                    //         "sig":{"0":48,"1":69,"2":2,"3":33,"4":0,"5":154,"6":37,"7":227,"8":249,"9":196,"10":159,"11":90,"12":177,"13":185,"14":113,"15":240,"16":218,"17":173,"18":15,"19":182,"20":52,"21":231,"22":229,"23":191,"24":28,"25":100,"26":8,"27":49,"28":59,"29":98,"30":129,"31":52,"32":140,"33":123,"34":231,"35":23,"36":210,"37":2,"38":32,"39":109,"40":62,"41":63,"42":78,"43":227,"44":219,"45":64,"46":64,"47":83,"48":224,"49":232,"50":46,"51":91,"52":188,"53":34,"54":182,"55":243,"56":39,"57":76,"58":250,"59":65,"60":139,"61":246,"62":213,"63":202,"64":140,"65":237,"66":236,"67":89,"68":175,"69":204,"70":39},
                    //         "x5c":[]
                    //     },
                    //     "authData":{"0":222,"1":18,"2":76,"3":101,"4":192,"5":156,"6":182,"7":184,"8":235,"9":237,"10":150,"11":40,"12":96,"13":225,"14":34,"15":50,"16":49,"17":153,"18":142,"19":246,"20":183,"21":25,"22":159,"23":128,"24":236,"25":224,"26":219,"27":164,"28":137,"29":113,"30":128,"31":251,"32":69,"33":91,"34":84,"35":15,"36":119,"37":173,"38":206,"39":0,"40":2,"41":53,"42":188,"43":198,"44":10,"45":100,"46":139,"47":11,"48":37,"49":241,"50":240,"51":85,"52":3,"53":0,"54":90,"55":0,"56":131,"57":99,"58":143,"59":14,"60":78,"61":87,"62":71,"63":29,"64":231,"65":182,"66":14,"67":88,"68":242,"69":122,"70":240,"71":137,"72":121,"73":111,"74":100,"75":252,"76":109,"77":104,"78":33,"79":28,"80":123,"81":114,"82":197,"83":199,"84":68,"85":89,"86":26,"87":181,"88":154,"89":5,"90":140,"91":57,"92":62,"93":212,"94":122,"95":209,"96":163,"97":136,"98":178,"99":70,"100":254,"101":173,"102":43,"103":65,"104":126,"105":228,"106":92,"107":68,"108":141,"109":12,"110":202,"111":111,"112":141,"113":191,"114":116,"115":5,"116":71,"117":77,"118":204,"119":114,"120":47,"121":53,"122":125,"123":28,"124":161,"125":126,"126":47,"127":144,"128":28,"129":236,"130":42,"131":72,"132":191,"133":226,"134":122,"135":109,"136":231,"137":253,"138":79,"139":191,"140":41,"141":64,"142":63,"143":244,"144":141,"145":165,"146":1,"147":2,"148":3,"149":38,"150":32,"151":1,"152":33,"153":88,"154":32,"155":224,"156":234,"157":4,"158":56,"159":142,"160":6,"161":30,"162":22,"163":185,"164":201,"165":20,"166":171,"167":32,"168":39,"169":36,"170":78,"171":201,"172":170,"173":84,"174":81,"175":249,"176":90,"177":70,"178":73,"179":144,"180":199,"181":88,"182":190,"183":80,"184":13,"185":44,"186":110,"187":34,"188":88,"189":32,"190":33,"191":1,"192":172,"193":193,"194":174,"195":85,"196":87,"197":225,"198":10,"199":57,"200":144,"201":213,"202":65,"203":248,"204":82,"205":201,"206":103,"207":15,"208":249,"209":77,"210":210,"211":201,"212":217,"213":6,"214":101,"215":195,"216":94,"217":135,"218":62,"219":157,"220":3,"221":127}
                    // }
                    return m.request({
                        method: 'POST', url: '/registration/finish',
                        data: cred,
                    });
                })
                .then(r => {
                    console.log(r);
                    updateBannerText('Registration complete', username);
                    updateUsers();
                })
                .catch(e => {
                    bannerText = e.toString();
                    console.error(e)
                    updateUsers();
                });
            }

            const RegisterUser = {
                username: sessionStorage.getItem('regUsername'),
                displayName: sessionStorage.getItem('regDisplayName'),
                view: vnode => m('', [
                    m('h2', "Register new user"),
                    m('label', 'Username', m('input', {
                        autocapitalize:'off',
                        value: vnode.state.username,
                        oninput: e => sessionStorage.setItem('regUsername', vnode.state.username = e.target.value),
                    })), m('br'),
                    m('label', 'Display Name', m('input', {
                        value: vnode.state.displayName,
                        oninput: e => sessionStorage.setItem('regDisplayName', vnode.state.displayName = e.target.value),
                    })), m('br'),
                    m('button', {onclick: _ => register(vnode.state.username, vnode.state.displayName)}, 'register'),
                ])
            }

            function login(username){
                m.request({
                    method: "POST", url: "/authentication/start",
                    data: { username: username }
                }).then(o => {
                    let getCredentialArgs = {
                        publicKey: {
                            timeout: 60000,
                            challenge: webauthn.strToBin(o.challenge).buffer,
                            allowCredentials : [{
                                id: webauthn.strToBin(o.credentialId).buffer,
                                transports: ["usb", "nfc", "ble"],
                                type: "public-key"
                            }],
                        },
                    };
                    console.log("what", getCredentialArgs);
                    return navigator.credentials.get(getCredentialArgs)
                })
                .then((assertion) => {
                    console.log("ASSERTION", assertion);
                    updateUsers()


                    return m.request({
                        method: "POST", url: "/authentication/finish",
                        data: assertion
                    });
                })
                .then(r => console.log(r))
                .catch((err) => {
                    bannerText = e.toString();
                    console.error(e);
                    updateUsers();
                })
            };

            const LoginAsUser = {
                username: sessionStorage.getItem('loginUsername'),
                view: vnode => m("", [
                    m('h2', "Login as user"),
                    m('label', 'Username', m('input', {
                        autocapitalize:"off",
                        value: vnode.state.username,
                        oninput: e => sessionStorage.setItem('loginUsername', vnode.state.username = e.target.value),
                    })), m('br'),
                    m('button', {onclick: _ => login(vnode.state.username)},'login')
                ])
            }

            function deleteUser(username) {
                console.log('Deleting user:', username)
                return m.request({method:'DELETE', url: `/users/${username}`}).then(_ => updateUsers());
            }

            const Userlist = {
                view: vnode => m('', [
                m('h2', "Registered users"),
                    m('table', [
                        m('thead', ['Username', 'Display Name', 'Challenge', 'Credential Id', 'Public Key', ''].map(v => m('td', v))),
                        m('tbody', users.map(u => m('tr',[
                            u.user.name, u.user.displayName, u.challenge, u.credentialId, u.publicKey,
                            m('button', {onclick: _ => deleteUser(u.user.name) },'delete')
                        ].map(v => m('td', v))),
                        ))
                    ])
                ])
            };

            const Layout = {
                oninit: updateUsers(),
                view: _ => m('', [
                    m('.banner', bannerText),
                    m('h1', 'WebAuthN'),
                    m(RegisterUser),
                    m(LoginAsUser),
                    (users.length !== 0) && m(Userlist),
                ])
            };

            m.mount(document.body, Layout);
        </script>
    </body>
</html>



